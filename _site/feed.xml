<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>coder_yu&#39;s BLOG</title>
    <description>this is my first blog. Now I&#39;m learning how to build it.</description>
    <link>http://yourdomain.com/</link>
    <atom:link href="http://yourdomain.com/feed.xml" rel="self" type="application/rss+xml"/>
    <pubDate>Mon, 20 Feb 2017 22:44:42 +0800</pubDate>
    <lastBuildDate>Mon, 20 Feb 2017 22:44:42 +0800</lastBuildDate>
    <generator>Jekyll v3.1.6</generator>
    
      <item>
        <title>Androidæ¶ˆæ¯åˆ†å‘åŠå¤šçº¿ç¨‹åˆ‡æ¢ä¹‹Handlerã€Messageçš„ç»†ææœ«èŠ‚ï¼ˆäºŒï¼‰</title>
        <description>&lt;p&gt;ä¹‹å‰è¯´äº†Androidæ¶ˆæ¯åˆ†å‘å’Œå¤šçº¿ç¨‹åˆ‡æ¢çš„æ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼Œè¿™æ¬¡æ¥è¯´ä¸€ä¸‹æ¶ˆæ¯ä¼ é€’çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œå¥½åƒä¸Šä¸€ç¯‡å†…å®¹ä¸çœ‹è²Œä¼¼ä¹Ÿå¯ä»¥ç›´æ¥çœ‹è¿™ç¯‡ï¼Œä¸è¿‡å»ºè®®è¿˜æ˜¯çœ‹ä¸€ä¸‹å¯ä»¥äº†è§£çš„æ›´é€å½»ä¸€ç‚¹å§~~&lt;/p&gt;

&lt;p&gt;ä¸Šä¸€ç¯‡è¯·çœ‹ï¼šhttp://www.jianshu.com/p/e914cda1b5fe&lt;/p&gt;

&lt;p&gt;ä¸‹é¢å¼€å§‹æœ¬ç¯‡çš„ä¸»é¢˜å§ï¼Œæˆ‘å°†æŒ‰ç…§Handlerå’ŒMessageçš„ä¸€èˆ¬ä½¿ç”¨æµç¨‹ï¼Œè·Ÿç€ä»£ç è°ƒç”¨é“¾ä¸€æ­¥æ­¥å¾€ä¸‹èµ°ï¼Œæ‰€ä»¥ï¼Œçœ‹ä»£ç å§ï¼&lt;/p&gt;

&lt;p&gt;é¦–å…ˆåœ¨ä¸»çº¿ç¨‹å®šä¹‰ä¸€ä¸ªhandlerï¼š&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;	Handler handler = new Handler(){
            @Override
            public void handleMessage(Message msg) {
                super.handleMessage(msg);
                switch (msg.what){
                    case TEST:
                        handleTest(msg);
                        break;
                    default:
                        handleDefault(msg);
                        break;
                }
            }
       };
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;ç„¶ååœ¨å·¥ä½œçº¿ç¨‹ä¸­ä½¿ç”¨æ‹¿åˆ°handlerçš„å¼•ç”¨ï¼Œç›´æ¥ä½¿ç”¨ï¼š&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;	new Thread(){
            @Override
            public void run() {
                super.run();
                Message message = Message.obtain();
                message.what = TEST;
                Bundle bundle =new Bundle();
                bundle.putString(&quot;test key&quot;,&quot;test value&quot;);
                message.setData(bundle);
       			handler.sendMessage(msg);                
            }
        }.start();
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;ä»¥ä¸Šå³ä¸ºä¸€ä¸ªç®€å•ä½¿ç”¨åœºæ™¯ï¼Œåœ¨å·¥ä½œçº¿ç¨‹ä¸­é€šè¿‡å°†Messageå‘é€åˆ°ä¸»çº¿ç¨‹çš„handlerï¼Œè®©handleråœ¨ä¸»çº¿ç¨‹ä¸­å¤„ç†UIç›¸å…³çš„æ“ä½œã€‚&lt;/p&gt;

&lt;p&gt;æˆ‘ä»¬ä»ç¬¬ä¸€æ®µä»£ç å¼€å§‹ï¼Œå…ˆçœ‹ä¸€ä¸‹Handlerçš„åˆ›å»ºè¿‡ç¨‹ã€‚å¾ˆç®€å•ï¼Œç›´æ¥newä¸€ä¸ªHandlerå¯¹è±¡ï¼Œç„¶åå®ç°å®ƒçš„&lt;strong&gt;handleMessage(Message msg)&lt;/strong&gt;æ–¹æ³•ï¼Œä½†æ˜¯è¿™ä¸ªhandlerå¯ä¸æ˜¯éšä¾¿å“ªé‡Œéƒ½èƒ½åˆ›å»ºçš„ï¼Œç›¸ä¿¡å¾ˆå¤šåŒå­¦è‚¯å®šä¹Ÿç¢°åˆ°è¿‡åœ¨åˆ«çš„çº¿ç¨‹ä¸­åˆ›å»ºhandleræŠ¥é”™çš„æƒ…å†µï¼Œç±»ä¼¼&lt;code class=&quot;highlighter-rouge&quot;&gt;Can&#39;t create handler inside thread that has not called Looper.prepare()&lt;/code&gt;è¿™æ ·çš„é”™è¯¯æç¤ºï¼Œä¸ºå•¥å‘¢ï¼Ÿ&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;	/**
     * Default constructor associates this handler with the {@link Looper} for the
     * current thread.
     *
     * If this thread does not have a looper, this handler won&#39;t be able to receive messages
     * so an exception is thrown.
     */
    public Handler() {
        this(null, false);
    }
    
   
    public Handler(Callback callback, boolean async) {
        if (FIND_POTENTIAL_LEAKS) {
            final Class&amp;lt;? extends Handler&amp;gt; klass = getClass();
            if ((klass.isAnonymousClass() || klass.isMemberClass() || klass.isLocalClass()) &amp;amp;&amp;amp;
                    (klass.getModifiers() &amp;amp; Modifier.STATIC) == 0) {
                Log.w(TAG, &quot;The following Handler class should be static or leaks might occur: &quot; +
                    klass.getCanonicalName());
            }
        }

        mLooper = Looper.myLooper();
        if (mLooper == null) {
            throw new RuntimeException(
                &quot;Can&#39;t create handler inside thread that has not called Looper.prepare()&quot;);
        }
        mQueue = mLooper.mQueue;
        mCallback = callback;
        mAsynchronous = async;
    }
    
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;æœ€ç»ˆè°ƒç”¨åˆ°çš„æ„é€ å™¨ä¸­çš„ç¬¬ä¸€å¤„åˆ¤æ–­æ˜¯ç”¨æ¥æ£€æµ‹å†…å­˜æ³„éœ²ç›¸å…³çš„ï¼Œæˆ‘ä»¬ä¸ç®¡ï¼Œçœ‹&lt;strong&gt;mLooper&lt;/strong&gt;å˜é‡çš„èµ‹å€¼ï¼š&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;	/**
     * Return the Looper object associated with the current thread.  Returns
     * null if the calling thread is not associated with a Looper.
     */
    public static @Nullable Looper myLooper() {
        return sThreadLocal.get();
    }
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;sThreadLocal.get()&lt;/strong&gt;æ–¹æ³•ä¸Šä¸€ç¯‡æˆ‘ä»¬è®²è¿‡äº†ï¼Œ&lt;strong&gt;sThreadLocal&lt;/strong&gt;æ˜¯ä¸€ä¸ªå…¨å±€çš„é™æ€å˜é‡ï¼Œä¿å­˜ç€çº¿ç¨‹å¯¹åº”çš„&lt;strong&gt;looper&lt;/strong&gt;å¯¹è±¡ï¼Œ&lt;strong&gt;get()&lt;/strong&gt;æ–¹æ³•ç”¨æ¥è·å–å½“å‰çº¿ç¨‹å¯¹åº”çš„&lt;strong&gt;looper&lt;/strong&gt;å¯¹è±¡ï¼Œç”±äºæˆ‘ä»¬è¿™ä¸ª&lt;strong&gt;handler&lt;/strong&gt;æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­åˆ›å»ºçš„ï¼Œè€Œä¸»çº¿ç¨‹åœ¨&lt;strong&gt;ActivityThread&lt;/strong&gt;çš„&lt;strong&gt;main()&lt;/strong&gt;æ–¹æ³•ä¸­å·²ç»ä¸ºæˆ‘ä»¬åˆ›å»ºäº†å¯¹åº”çš„&lt;strong&gt;looper&lt;/strong&gt;å¯¹è±¡ï¼Œå› æ­¤æˆ‘ä»¬è¿™é‡Œå»getçš„è¯æ˜¯èƒ½å–åˆ°å€¼çš„ï¼Œæ‰€ä»¥ä¸‹é¢ä¸€è¡Œçš„åˆ¤æ–­ä¸ä¼šæŠ›å¼‚å¸¸ã€‚ä½†æ˜¯ä¸€èˆ¬çš„å·¥ä½œçº¿ç¨‹ï¼Œæˆ‘ä»¬å¦‚æœæ²¡ç”¨ä¸ºå®ƒåˆ›å»º&lt;strong&gt;Looper&lt;/strong&gt;å¯¹è±¡ï¼Œå®ƒæ˜¯æ²¡æœ‰å¯¹åº”çš„&lt;strong&gt;Looper&lt;/strong&gt;å¯¹è±¡ä¿å­˜åœ¨&lt;strong&gt;sThreadLocal&lt;/strong&gt;ä¸­çš„ï¼Œå› æ­¤&lt;strong&gt;Looper.myLooper()&lt;/strong&gt;å°±ä¼šè¿”å›nullï¼Œæ¥ä¸‹å»å°±ä¼šæŠ¥é”™ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢è¯´çš„åœ¨å·¥ä½œçº¿ç¨‹ä¸­åˆ›å»ºhandlerä¼šæŠ¥é”™çš„åŸå› ã€‚å–åˆ°&lt;strong&gt;mLooper&lt;/strong&gt;ä¹‹åï¼Œå°†&lt;strong&gt;mLooper&lt;/strong&gt;ä¸­çš„ä¿å­˜&lt;strong&gt;Message&lt;/strong&gt;çš„&lt;strong&gt;MessageQueue&lt;/strong&gt;ä¹Ÿå–å‡ºä¿å­˜åœ¨&lt;strong&gt;handler&lt;/strong&gt;çš„å±æ€§&lt;strong&gt;mQueue&lt;/strong&gt;ä¸­ï¼Œç„¶åå°†æ„é€ å™¨çš„å‚æ•°&lt;strong&gt;callback&lt;/strong&gt;å’Œ&lt;strong&gt;async&lt;/strong&gt;èµ‹å€¼ï¼Œæˆ‘ä»¬è¿™é‡Œéƒ½ä¸ºnullã€‚&lt;/p&gt;

&lt;p&gt;è¿™é‡Œå¤§è‡´ä»‹ç»ä¸‹&lt;strong&gt;Handler&lt;/strong&gt;çš„å‡ ä¸ªå±æ€§ï¼š&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;boolean mAsynchronousï¼š&lt;/strong&gt;&lt;/p&gt;

    &lt;p&gt;è¿™ä¸ªæ˜¯ç”¨æ¥è¡¨æ˜å¤„ç†&lt;strong&gt;Message&lt;/strong&gt;çš„æ—¶å€™æ˜¯å¦éœ€è¦ä¿è¯é¡ºåºï¼Œé»˜è®¤ä¸ºfalseï¼Œè€Œä¸”æˆ‘ä»¬å…¶å®ä¹Ÿæ²¡åŠæ³•å»å°†ä»–è®¾ç½®ä¸ºtrueï¼Œå› ä¸ºè¿™äº›æ„é€ å™¨éƒ½æ˜¯&lt;code class=&quot;highlighter-rouge&quot;&gt;@hide&lt;/code&gt;çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¸ç®¡å®ƒã€‚&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Callback mCallbackï¼š&lt;/strong&gt;&lt;/p&gt;

    &lt;p&gt;è¿™ä¸ªæ˜¯Handlerçš„å†…éƒ¨æ¥å£&lt;strong&gt;Callback&lt;/strong&gt;ç±»å‹çš„ä¸€ä¸ªå±æ€§ï¼Œå®ƒå°±ä¸€ä¸ªæ–¹æ³•ï¼Œä¹Ÿå«
&lt;strong&gt;handleMessage(Message msg)&lt;/strong&gt;,åªèƒ½åœ¨æ„é€ å™¨ä¸­ä¼ å‚ï¼Œå¦‚æœæˆ‘ä»¬åœ¨æ„é€ å™¨ä¸­ç»™äº†è¿™ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆå‘é€ç»™è¿™ä¸ª&lt;strong&gt;handler&lt;/strong&gt;çš„æ¶ˆæ¯å°†ä¼˜å…ˆä¼šç”±è¿™ä¸ª&lt;strong&gt;mCallback&lt;/strong&gt;æ¥æ‰§è¡Œï¼Œä¸è¿‡ç›®å‰ä¸ºæ­¢æˆ‘å¹¶ä¸æ¸…æ¥šå“ªäº›åœºæ™¯é€‚ç”¨è¿™ç§æ–¹å¼ï¼ŒçŸ¥é“çš„åŒå­¦æ¬¢è¿æŒ‡æ•™ä¸€ä¸‹~&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Looper mLooper:&lt;/strong&gt;&lt;/p&gt;

    &lt;p&gt;&lt;strong&gt;handler&lt;/strong&gt;æ˜¯ç”¨æ¥å¤„ç†&lt;strong&gt;Message&lt;/strong&gt;çš„ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»è¦æœ‰&lt;strong&gt;Message&lt;/strong&gt;æ¥æºï¼Œè€Œ&lt;strong&gt;Message&lt;/strong&gt;çš„æ¥æº&lt;strong&gt;MessageQueue&lt;/strong&gt;æ˜¯åœ¨&lt;strong&gt;Looper&lt;/strong&gt;ä¸­çš„ï¼Œå› æ­¤&lt;strong&gt;handler&lt;/strong&gt;éœ€è¦ä¸€ä¸ª&lt;strong&gt;Looper&lt;/strong&gt;å±æ€§ã€‚ä¸€èˆ¬æƒ…å†µä¸‹&lt;strong&gt;mLooper&lt;/strong&gt;å³ä¸ºä¸»çº¿ç¨‹æˆ–è€…è¯´æ˜¯åˆ›å»ºå®ƒçš„çº¿ç¨‹æ‰€å¯¹åº”çš„&lt;strong&gt;Looper&lt;/strong&gt;,ä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¼ ä¸€ä¸ªLooperå¯¹è±¡ç»™å®ƒï¼Œå…³äºè¿™ä¸ªå¯ä»¥çœ‹çœ‹&lt;code class=&quot;highlighter-rouge&quot;&gt;HandlerThread&lt;/code&gt;çš„ç›¸å…³çŸ¥è¯†ã€‚&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;MessageQueue mQueueï¼š&lt;/strong&gt;&lt;/p&gt;

    &lt;p&gt;æ²¡å•¥å¥½è¯´çš„ï¼Œè¿™ä¸ªå°±æ˜¯&lt;strong&gt;handler&lt;/strong&gt;è¦å¤„ç†çš„æ¶ˆæ¯çš„æ¥æºäº†,å®ƒå’Œ&lt;strong&gt;Looper&lt;/strong&gt;ä¸­çš„&lt;strong&gt;mQueue&lt;/strong&gt;æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ã€‚&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;åœ¨çœ‹ä¸€ä¸‹&lt;strong&gt;Handler&lt;/strong&gt;çš„æ¶ˆæ¯åˆ†å‘æ–¹æ³•ï¼š&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;	/**
     * Handle system messages here.
     */
    public void dispatchMessage(Message msg) {
        if (msg.callback != null) {
            handleCallback(msg);
        } else {
            if (mCallback != null) {
                if (mCallback.handleMessage(msg)) {
                    return;
                }
            }
            handleMessage(msg);
        }
    }
    
    private static void handleCallback(Message message) {
        message.callback.run();
    }
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;è¿˜è®°å¾—ä¸Šä¸€ç¯‡ä¸­æœ€åçº¿ç¨‹åœç•™çš„é‚£ä¸ªæ­»å¾ªç¯å—ï¼Œé‡Œé¢æœ‰ä¸€è¡Œä»£ç &lt;code class=&quot;highlighter-rouge&quot;&gt; msg.target.dispatchMessage(msg);&lt;/code&gt;,è¿™é‡Œæ¯æ¬¡å–å‡ºçš„&lt;strong&gt;Message&lt;/strong&gt;éƒ½ä¼šè¢«å®ƒå¯¹åº”çš„&lt;strong&gt;target&lt;/strong&gt;ä¹Ÿå°±æ˜¯&lt;strong&gt;Handler&lt;/strong&gt;å¯¹è±¡åˆ†å‘ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢è¿™æ®µä»£ç ã€‚&lt;/p&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°é¦–å…ˆä¼šåˆ¤æ–­&lt;strong&gt;Message&lt;/strong&gt;å¯¹è±¡è‡ªå·±çš„&lt;strong&gt;callback&lt;/strong&gt;æ˜¯å¦ä¸ºç©ºï¼Œå®ƒæ˜¯ä¸€ä¸ª&lt;strong&gt;Runnable&lt;/strong&gt;å¯¹è±¡ï¼Œå¦‚æœä¸ä¸ºç©ºç›´æ¥è°ƒç”¨&lt;strong&gt;callback&lt;/strong&gt;çš„&lt;strong&gt;run()&lt;/strong&gt;æ–¹æ³•ï¼Œå¦åˆ™åˆ¤æ–­&lt;strong&gt;handler&lt;/strong&gt;çš„å±æ€§&lt;strong&gt;mCallback&lt;/strong&gt;æ˜¯å¦ä¸ºç©ºï¼Œå±æ€§ä»‹ç»çš„æ—¶å€™å·²ç»è®²è¿‡è¿™ä¸ªäº†ï¼Œå¦‚æœä¸ä¸ºç©ºåˆ™åˆ™è°ƒç”¨&lt;strong&gt;mCallback.handleMessage(msg)&lt;/strong&gt;æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›trueå°±ç›´æ¥returnï¼Œå¦åˆ™è°ƒç”¨&lt;strong&gt;handler&lt;/strong&gt;çš„&lt;strong&gt;handlerMessage(msg)&lt;/strong&gt;æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¦ç»§æ‰¿&lt;strong&gt;Handler&lt;/strong&gt;è¦å®ç°çš„æ–¹æ³•ï¼Œè¿™ä¸ªæ˜¯ä¸æ˜¯æœ‰ç‚¹ç±»ä¼¼äºAndroidç³»ç»Ÿçš„å±å¹•äº‹ä»¶ä¼ é€’æœºåˆ¶å‘¢ï¼Ÿå“ˆå“ˆ~&lt;/p&gt;

&lt;p&gt;è¯è¯´ç¬¬ä¸€ç¯‡é‡Œæœ‰ä¸ªå‘è¿˜æ²¡å¡«ï¼Œå°±æ˜¯å¦‚ä½•åœ¨å·¥ä½œçº¿ç¨‹åˆ›å»ºä½¿ç”¨&lt;strong&gt;Handler&lt;/strong&gt;ï¼Œä¸è¿‡ç›¸ä¿¡çœ‹åˆ°è¿™é‡Œçš„åŒå­¦åº”è¯¥å·²ç»å¿ƒé‡Œæœ‰åº•äº†å§ï¼Œå‚è€ƒä¸Šä¸€ç¯‡ä¸­&lt;strong&gt;ActivityThread&lt;/strong&gt;ä¸­çš„&lt;strong&gt;main()&lt;/strong&gt;æ–¹æ³•ï¼Œå¾ˆå®¹æ˜“åˆ›å»ºè‡ªå·±çš„æ— çº¿å¾ªç¯å·¥ä½œçº¿ç¨‹äº†ï¼Œä¸‹é¢ç›´æ¥ç»™å‡ºä»£ç ï¼š&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;	new Thread(){
            Handler handler;
            @Override
            public void run() {
                super.run();
                Looper.prepare();
                 handler = new Handler(){
                    @Override
                    public void handleMessage(Message msg) {
                        super.handleMessage(msg);
                        //handler the message
                    }
                };
                Looper.loop();
            }
        };
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;ä»¥ä¸Šï¼Œå³åœ¨å·¥ä½œçº¿ç¨‹ä¸­åˆ›å»ºäº†&lt;strong&gt;handler&lt;/strong&gt;,ç„¶åå°†&lt;strong&gt;handler&lt;/strong&gt;çš„å¼•ç”¨ä¸¢ç»™åˆ«çš„çº¿ç¨‹ï¼Œåˆ«çš„çº¿ç¨‹å°±å¯ä»¥é€šè¿‡&lt;strong&gt;handler&lt;/strong&gt;å‘æ¶ˆæ¯åˆ°è¿™ä¸ªå·¥ä½œçº¿ç¨‹æ¥å¤„ç†ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Handler&lt;/strong&gt;å¯¹äºæ¶ˆæ¯çš„åˆ†å‘å’Œå¤„ç†çš„é€»è¾‘æ€»ç®—è¯´å®Œäº†ï¼Œæ¥ä¸‹å»çœ‹çœ‹&lt;strong&gt;Message&lt;/strong&gt;æ˜¯å¦‚ä½•è¢«é€åˆ°&lt;strong&gt;Handler&lt;/strong&gt;çš„ã€‚
å…ˆçœ‹ä¸‹&lt;strong&gt;Message&lt;/strong&gt;çš„åŸºæœ¬ä¿¡æ¯å§ï¼š&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;int what:&lt;/strong&gt;&lt;/p&gt;

    &lt;p&gt;è¡¨æ˜æ¶ˆæ¯çš„ç±»åˆ«ï¼Œ&lt;strong&gt;handler&lt;/strong&gt;æ ¹æ®è¿™ä¸ªå­—æ®µæ¥åˆ¤æ–­å¦‚ä½•å¤„ç†è¿™ä¸ª&lt;strong&gt;Message&lt;/strong&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Bundle dataï¼š&lt;/strong&gt;&lt;/p&gt;

    &lt;p&gt;ç”¨äºå­˜æ”¾æ•°æ®ï¼Œå¯ä»¥å­˜æ”¾ä¸€äº›ç›¸å¯¹å¤æ‚çš„å†…å®¹ï¼Œå› æ­¤å¼€é”€ç¨å¾®å¤§ä¸€ç‚¹&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;int arg1,arg2:&lt;/strong&gt;&lt;/p&gt;

    &lt;p&gt;ä¸¤ä¸ªåŸºæœ¬ç±»å‹çš„å‚æ•°ï¼Œç”¨äºä¼ é€’ä¸€äº›ç®€å•çš„&lt;strong&gt;Message&lt;/strong&gt;ä¿¡æ¯ï¼Œå¯ä»¥çš„è¯å°½é‡ç”¨è¿™ä¸¤ä¸ªå‚æ•°æ¥ä¼ é€’ä¿¡æ¯ï¼Œç›¸å¯¹äº&lt;strong&gt;Bundle data&lt;/strong&gt;å®ƒæ€§èƒ½æ¶ˆè€—ä¼šå°å¾ˆå¤š&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;int flags:&lt;/strong&gt;&lt;/p&gt;

    &lt;p&gt;å½“å‰&lt;strong&gt;Message&lt;/strong&gt;çŠ¶æ€çš„ä¸€ä¸ªæ ‡å¿—ä½ï¼Œç±»ä¼¼å¼‚æ­¥ï¼Œä½¿ç”¨ä¸­è¿™äº›çŠ¶æ€&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;long whenï¼š&lt;/strong&gt;&lt;/p&gt;

    &lt;p&gt;è¡¨ç¤ºè¿™ä¸ª&lt;strong&gt;Message&lt;/strong&gt;åº”è¯¥åœ¨ä½•æ—¶è¢«æ‰§è¡Œï¼Œ&lt;strong&gt;MessageQueue&lt;/strong&gt;ä¸­&lt;strong&gt;Message&lt;/strong&gt;å°±æ˜¯ä»¥è¿™ä¸ªå­—æ®µä¸ºæ¥æ’åºçš„&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Handler targetï¼š&lt;/strong&gt;&lt;/p&gt;

    &lt;p&gt;&lt;strong&gt;Message&lt;/strong&gt;å°†è¦è¢«å‘é€çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ç”±å“ªä¸ªtargetæ¥æ¥å—å¤„ç†è¿™ä¸ª&lt;strong&gt;Message&lt;/strong&gt;ï¼Œ&lt;strong&gt;è¿™ä¸ªå­—æ®µå¿…é¡»ä¸ä¸ºnull&lt;/strong&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Runnable callbackï¼š&lt;/strong&gt;&lt;/p&gt;

    &lt;p&gt;è¿™ä¸ªè®²&lt;strong&gt;handler&lt;/strong&gt;çš„æ—¶å€™è¯´åˆ°è¿‡äº†ï¼Œå¦‚æœæœ‰è¿™ä¸ªå­—æ®µï¼Œé‚£ä¹ˆè¿™ä¸ª&lt;strong&gt;Message&lt;/strong&gt;å°†ç”±æ­¤&lt;strong&gt;callback&lt;/strong&gt;æ¥å¤„ç†ï¼Œæ³¨æ„ä¸‹ï¼Œå®ƒæ˜¯ä¸€ä¸ª&lt;strong&gt;Runnable&lt;/strong&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Message next:&lt;/strong&gt;&lt;/p&gt;

    &lt;p&gt;ç”±äº&lt;strong&gt;Message&lt;/strong&gt;åœ¨æ¶ˆæ¯æ± ä¸­æ˜¯é“¾è¡¨çš„å½¢å¼ç»´æŠ¤çš„ï¼Œæ‰€ä»¥è¿™ä¸ªå­—æ®µè¡¨ç¤ºä¸‹ä¸€ä¸ª&lt;strong&gt;Message&lt;/strong&gt;å¯¹è±¡&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;static Message sPoolï¼š&lt;/strong&gt;&lt;/p&gt;

    &lt;p&gt;è¿™ä¸ªæ˜¯é™æ€å˜é‡ï¼ŒæŒ‡å‘å½“å‰æ¶ˆæ¯æ± çš„ç¬¬ä¸€ä¸ªç©ºé—²&lt;strong&gt;Message&lt;/strong&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;static int sPoolSize:&lt;/strong&gt;&lt;/p&gt;

    &lt;p&gt;æ¶ˆæ¯æ± çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯å‰©ä½™ç©ºé—²&lt;strong&gt;Message&lt;/strong&gt;çš„æ•°é‡&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;static final int MAX_POOL_SIZE = 50;&lt;/strong&gt;&lt;/p&gt;

    &lt;p&gt;ä¸ç”¨è§£é‡Šäº†å§ï¼Ÿ&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å†è´´ä¸€ä¸‹ä¾‹å­ä¸­çš„ç¬¬äºŒæ®µä»£ç ï¼š&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;	new Thread(){
            @Override
            public void run() {
                super.run();
                Message message = Message.obtain();
                message.what = TEST;
                Bundle bundle =new Bundle();
                bundle.putString(&quot;test key&quot;,&quot;test value&quot;);
                message.setData(bundle);
       			handler.sendMessage(msg);                
            }
        }.start();
        
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;Message&lt;/strong&gt;çš„è·å–æ–¹å¼ç‰¹åˆ«å¤šï¼Œé™¤äº†è‡ªå·±newä¸€ä¸ªå¤–ï¼Œå…¶ä»–åŸºæœ¬éƒ½å¤§åŒå°å¼‚ï¼Œæœ€ç»ˆéƒ½ä»&lt;strong&gt;Message&lt;/strong&gt;æ¶ˆæ¯æ± å–ä¸€ä¸ªç©ºé—²çš„&lt;strong&gt;Message&lt;/strong&gt;ä½¿ç”¨ï¼Œå› ä¸ºAndroidç³»ç»Ÿä¸­åˆ°å¤„éƒ½ç”¨åˆ°äº†&lt;strong&gt;Message&lt;/strong&gt;ï¼Œå› æ­¤ä¼šéœ€è¦å¤§é‡çš„&lt;strong&gt;Message&lt;/strong&gt;å¯¹è±¡ï¼Œä½¿ç”¨æ¶ˆæ¯æ± çš„æ–¹å¼å¯ä»¥å‡å°‘é¢‘ç¹çš„åˆ›å»ºé”€æ¯å¯¹è±¡ï¼Œå¤§å¤§çš„æé«˜æ€§èƒ½ã€‚æˆ‘è¿™é‡Œç›´æ¥ç”¨æœ€åŸºæœ¬çš„æ–¹å¼è·å–ï¼Œ&lt;code class=&quot;highlighter-rouge&quot;&gt;Message.obtain();&lt;/code&gt;,çœ‹æºç å§ï¼š&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;	/**
     * Return a new Message instance from the global pool. Allows us to
     * avoid allocating new objects in many cases.
     */
    public static Message obtain() {
        synchronized (sPoolSync) {
            if (sPool != null) {
                Message m = sPool;
                sPool = m.next;
                m.next = null;
                m.flags = 0; // clear in-use flag
                sPoolSize--;
                return m;
            }
        }
        return new Message();
    }
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;å¯¹ç€ä¸Šé¢çš„å­—æ®µä»‹ç»ï¼Œå¾ˆå®¹æ˜“çœ‹å‡ºè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å°±æ˜¯å°†æ¶ˆæ¯æ± çš„ç¬¬ä¸€ä¸ªç©ºé—²&lt;strong&gt;Message&lt;/strong&gt;æ‹¿å‡ºæ¥ï¼Œç„¶åæ¶ˆæ¯æ± çš„æ•°é‡å‡1ï¼Œå½“ç„¶å¦‚æœæ¶ˆæ¯æ± å·²ç»æ²¡ç”¨ç©ºé—²&lt;strong&gt;Message&lt;/strong&gt;äº†ï¼Œé‚£å°±newä¸€ä¸ªè¿”å›äº†ã€‚&lt;/p&gt;

&lt;p&gt;ä¾‹å­ä¸­åªç”¨åˆ°äº†&lt;strong&gt;what&lt;/strong&gt;å’Œ&lt;strong&gt;data&lt;/strong&gt;å­—æ®µï¼Œç®€å•ç»™å®ƒä»¬èµ‹äº†å€¼ï¼Œç„¶åå°±è°ƒç”¨&lt;strong&gt;handler.sendMessage(msg); **å°†æ¶ˆæ¯å‘é€ç»™äº†æˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹åˆ›å»ºçš„&lt;/strong&gt;handler**äº†ã€‚&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;	public final boolean sendMessage(Message msg)
    {
        return sendMessageDelayed(msg, 0);
    }
    
    public final boolean sendMessageDelayed(Message msg, long delayMillis)
    {
        if (delayMillis &amp;lt; 0) {
            delayMillis = 0;
        }
        return sendMessageAtTime(msg, SystemClock.uptimeMillis() + delayMillis);
    }
    
    /**
     * Enqueue a message into the message queue after all pending messages
     * before the absolute time (in milliseconds) &amp;lt;var&amp;gt;uptimeMillis&amp;lt;/var&amp;gt;.
     * &amp;lt;b&amp;gt;The time-base is {@link android.os.SystemClock#uptimeMillis}.&amp;lt;/b&amp;gt;
     * Time spent in deep sleep will add an additional delay to execution.
     * You will receive it in {@link #handleMessage}, in the thread attached
     * to this handler.
     * 
     * @param uptimeMillis The absolute time at which the message should be
     *         delivered, using the
     *         {@link android.os.SystemClock#uptimeMillis} time-base.
     *         
     * @return Returns true if the message was successfully placed in to the 
     *         message queue.  Returns false on failure, usually because the
     *         looper processing the message queue is exiting.  Note that a
     *         result of true does not mean the message will be processed -- if
     *         the looper is quit before the delivery time of the message
     *         occurs then the message will be dropped.
     */
    public boolean sendMessageAtTime(Message msg, long uptimeMillis) {
        MessageQueue queue = mQueue;
        if (queue == null) {
            RuntimeException e = new RuntimeException(
                    this + &quot; sendMessageAtTime() called with no mQueue&quot;);
            Log.w(&quot;Looper&quot;, e.getMessage(), e);
            return false;
        }
        return enqueueMessage(queue, msg, uptimeMillis);
    }
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;å‰é¢ä¸¤ä¸ªæ–¹æ³•çš„æ³¨é‡Šæˆ‘æ²¡è´´ï¼Œå› ä¸ºè·Ÿç¬¬ä¸‰ä¸ªæ–¹æ³•å†…å®¹å·®ä¸å¤šï¼Œè€Œä¸”æœ€ç»ˆä¹Ÿéƒ½æ˜¯è°ƒç”¨ç¬¬ä¸‰ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥çœ‹äº†ç¬¬ä¸‰ä¸ªæ–¹æ³•çš„æ³¨é‡Šå’Œæ–¹æ³•ä½“åº”è¯¥å¾ˆå®¹æ˜“æ˜ç™½å‰ä¸¤ä¸ªæ–¹æ³•çš„ä½œç”¨ã€‚
ç¬¬ä¸€ä¸ªæ–¹æ³•æ˜¯ç›´æ¥å°†æ¶ˆæ¯å‘é€handlerå¤„ç†ï¼Œæ‰€ä»¥å®ƒä½¿ç”¨0æ¯«ç§’çš„å»¶æ—¶ä½œä¸ºå‚æ•°è°ƒç”¨ç¬¬äºŒä¸ªæ–¹æ³•ï¼Œç¬¬äºŒä¸ªæ–¹æ³•åˆ¤æ–­å¦‚æœå»¶æ—¶å°äº0åˆ™é»˜è®¤ç»™0ï¼Œå› ä¸ºå°äº0çš„å»¶è¿Ÿä¹Ÿå°±æ„å‘³ç€æ¯”å½“å‰æ—¶é—´æ—©ï¼Œå½“ç„¶ä¸å¯èƒ½å›åˆ°è¿‡å»å¤„ç†è¿™ä¸ªæ¶ˆæ¯äº†ï¼Œç„¶åå®ƒåˆå°†å½“å‰æ—¶é—´åŠ ä¸Šå»¶æ—¶ï¼Œè°ƒç”¨äº†ç¬¬ä¸‰ä¸ªæ–¹æ³•ï¼Œè¿™æ ·ç¬¬ä¸‰ä¸ªæ–¹æ³•æ‹¿åˆ°çš„æ—¶é—´å°±æ˜¯ä¸€ä¸ªç»å¯¹å€¼äº†ï¼Œç„¶åæˆ‘ä»¬çœ‹åˆ°äº†&lt;strong&gt;mQueue&lt;/strong&gt;ï¼Œè¿™ä¸ªåˆ›å»º&lt;strong&gt;handler&lt;/strong&gt;çš„æ—¶å€™æˆ‘ä»¬å°±çœ‹åˆ°äº†ï¼ŒæŒ‡å‘ä¸»çº¿ç¨‹å¯¹åº”çš„&lt;strong&gt;Looper&lt;/strong&gt;ä¸­çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæœ€åreturnäº†ä¸€ä¸ªæ–¹æ³•è°ƒç”¨ï¼Œçœ‹åå­—ç»ˆäºè¦åŠ å…¥æ¶ˆæ¯é˜Ÿåˆ—äº†ã€‚&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; 	private boolean enqueueMessage(MessageQueue queue, Message msg, long uptimeMillis) {
        msg.target = this;
        if (mAsynchronous) {
            msg.setAsynchronous(true);
        }
        return queue.enqueueMessage(msg, uptimeMillis);
    }
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;ç­‰ç­‰ï¼ŒåŸæ¥æˆ‘ä»¬åˆšæ‰å‘é€çš„&lt;strong&gt;Message&lt;/strong&gt;è¿˜æ²¡å¯¹è±¡å‘¢ï¼Œé‚£å•¥ï¼Œæˆ‘ä¸æ˜¯è¯´é‚£ä¸ªå¯¹è±¡ï¼Œæ­£ç»ç‚¹å„¿ï¼æ‰€ä»¥åŠ å…¥æ¶ˆæ¯é˜Ÿåˆ—å‰å…ˆç»™å®ƒä¸€ä¸ªå¯¹è±¡å§ï¼ç„¶åå¦‚æœæˆ‘ä»¬çš„&lt;strong&gt;handler&lt;/strong&gt;æ˜¯å¼‚æ­¥çš„å°†&lt;strong&gt;msg&lt;/strong&gt;çš„&lt;strong&gt;flag&lt;/strong&gt;æ ‡å¿—ä½åŠ ä¸Šæˆå¼‚æ­¥,è¿™ä¸‹&lt;strong&gt;msg&lt;/strong&gt;å¼€å¼€å¿ƒå¿ƒåœ°é¢†ç€å¯¹è±¡å»æ’é˜Ÿäº†~&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;	//MessageQueue
	boolean enqueueMessage(Message msg, long when) {
        if (msg.target == null) {
            throw new IllegalArgumentException(&quot;Message must have a target.&quot;);
        }
        if (msg.isInUse()) {
            throw new IllegalStateException(msg + &quot; This message is already in use.&quot;);
        }

        synchronized (this) {
            if (mQuitting) {
                IllegalStateException e = new IllegalStateException(
                        msg.target + &quot; sending message to a Handler on a dead thread&quot;);
                Log.w(TAG, e.getMessage(), e);
                msg.recycle();
                return false;
            }

            msg.markInUse();
            msg.when = when;
            Message p = mMessages;
            boolean needWake;
            if (p == null || when == 0 || when &amp;lt; p.when) {
                // New head, wake up the event queue if blocked.
                msg.next = p;
                mMessages = msg;
                needWake = mBlocked;
            } else {
                // Inserted within the middle of the queue.  Usually we don&#39;t have to wake
                // up the event queue unless there is a barrier at the head of the queue
                // and the message is the earliest asynchronous message in the queue.
                needWake = mBlocked &amp;amp;&amp;amp; p.target == null &amp;amp;&amp;amp; msg.isAsynchronous();
                Message prev;
                for (;;) {
                    prev = p;
                    p = p.next;
                    if (p == null || when &amp;lt; p.when) {
                        break;
                    }
                    if (needWake &amp;amp;&amp;amp; p.isAsynchronous()) {
                        needWake = false;
                    }
                }
                msg.next = p; // invariant: p == prev.next
                prev.next = msg;
            }

            // We can assume mPtr != 0 because mQuitting is false.
            if (needWake) {
                nativeWake(mPtr);
            }
        }
        return true;
    }

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;é¦–å…ˆåˆ¤æ–­&lt;strong&gt;Message&lt;/strong&gt;çš„å¯¹è±¡&lt;strong&gt;target&lt;/strong&gt;æ˜¯å¦ä¸ºç©º(æ‰€ä»¥è¯´&lt;strong&gt;Message&lt;/strong&gt;ä¸èƒ½æ²¡æœ‰å¯¹è±¡&lt;strong&gt;target&lt;/strong&gt;),ç„¶ååˆ¤æ–­&lt;strong&gt;Message&lt;/strong&gt;æ˜¯å¦æ­£åœ¨ä½¿ç”¨ä¸­,åœ¨ç»å†çš„å‰é¢çš„å…¥é˜Ÿæ­¥éª¤åï¼Œæˆ‘ä»¬è¿™ä¸ª&lt;strong&gt;Message&lt;/strong&gt;éƒ½æ»¡è¶³äº†æ¡ä»¶ï¼Œç„¶åè¿›å…¥ä¸€ä¸ªåŒæ­¥å—ï¼Œé¦–å…ˆåˆ¤æ–­æ˜¯å¦æ­£åœ¨é€€å‡ºä¸­ï¼Œå› ä¸ºä¸»çº¿ç¨‹æ˜¯ä¸å¯é€€å‡ºçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿä¸ç”¨è€ƒè™‘ï¼Œä¸è¿‡é‡Œé¢æ–¹æ³•ä¹Ÿæ˜¯ä¸€ç›®äº†ç„¶ï¼Œå›æ”¶&lt;strong&gt;Message&lt;/strong&gt;,è¿”å›&lt;strong&gt;false&lt;/strong&gt;é€šçŸ¥ä¸Šå±‚å…¥é˜Ÿå¤±è´¥ã€‚æˆ‘ä»¬ç»§ç»­çœ‹æ»¡è¶³æ¡ä»¶çš„æƒ…å†µä¸‹ï¼Œå°†&lt;strong&gt;Message&lt;/strong&gt;æ ‡è®°ä¸ºåœ¨ä½¿ç”¨ä¸­(&lt;code class=&quot;highlighter-rouge&quot;&gt;msg.markInUse()&lt;/code&gt;),ç»™&lt;strong&gt;when&lt;/strong&gt;å­—æ®µèµ‹å€¼ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡æŒ‡å‘æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯&lt;strong&gt;mMessage&lt;/strong&gt;ï¼Œå®šä¹‰äº†ä¸€ä¸ªå¸ƒå°”ç±»å‹çš„å­—æ®µ&lt;strong&gt;needWake&lt;/strong&gt;,è¡¨ç¤ºæ˜¯å¦éœ€è¦å”¤é†’å½“å‰çº¿ç¨‹ï¼Œå› ä¸ºæ²¡æœ‰æ¶ˆæ¯éœ€è¦å¤„ç†çš„æ—¶å€™æˆ‘ä»¬çš„Looperçº¿ç¨‹æ˜¯é˜»å¡çš„ã€‚å½“æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯ä¸º&lt;strong&gt;null&lt;/strong&gt;æˆ–è€…æˆ‘ä»¬æœ¬æ¬¡éœ€è¦å…¥é˜Ÿçš„æ¶ˆæ¯å¯¹è±¡&lt;strong&gt;msg&lt;/strong&gt;çš„&lt;strong&gt;when&lt;/strong&gt;ä¸º0æˆ–è€…å°äºåŸæ¥çš„é˜Ÿé¦–æ¶ˆæ¯çš„&lt;strong&gt;when&lt;/strong&gt;å€¼ï¼Œåˆ™å°†&lt;strong&gt;msg&lt;/strong&gt;æ’å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„é˜Ÿé¦–ï¼Œä¹Ÿå°±æ˜¯&lt;strong&gt;mMessage&lt;/strong&gt;ä¹‹å‰ï¼Œç„¶å&lt;strong&gt;mMessage&lt;/strong&gt;é‡æ–°æŒ‡å‘æ–°çš„é˜Ÿé¦–ï¼Œä¹Ÿå°±æ˜¯&lt;strong&gt;msg&lt;/strong&gt;ï¼›å½“é‚£äº›æ¡ä»¶ä¸æ»¡è¶³çš„æ—¶å€™ï¼Œåˆ™éœ€è¦å°†&lt;strong&gt;msg&lt;/strong&gt;æ’å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­è€Œä¸æ˜¯é˜Ÿé¦–ï¼Œæ’å…¥çš„æ–¹å¼ä¹Ÿå¾ˆç®€å•é™¤æš´ï¼Œéå†åŸé˜Ÿåˆ—çš„æ¶ˆæ¯ï¼Œä¾æ¬¡æ¯”å¯¹&lt;strong&gt;when&lt;/strong&gt;çš„å€¼ï¼Œç›´åˆ°é˜Ÿå°¾æˆ–è€…æ‰¾åˆ°ä¸‹ä¸€ä¸ªæ¶ˆæ¯çš„&lt;strong&gt;when&lt;/strong&gt;å€¼æ¯”&lt;strong&gt;msg&lt;/strong&gt;çš„&lt;strong&gt;when&lt;/strong&gt;å€¼å¤§çš„æ—¶å€™è·³å‡ºå¾ªç¯ï¼Œå°†&lt;strong&gt;msg&lt;/strong&gt;æ’åˆ°å…¶ä¸­ï¼Œè¿™ä¸ªå…¥é˜Ÿçš„è¿‡ç¨‹ä¹Ÿå°±å®Œæˆäº†ï¼Œéƒ½æ˜¯ä¸€äº›é“¾è¡¨çš„åŸºæœ¬æ“ä½œã€‚ä¹‹å‰ä¹Ÿæœ‰è¯´åˆ°ï¼Œå› ä¸ºæ¯æ¬¡æœ‰æ¶ˆæ¯è¿›å…¥&lt;strong&gt;mQueue&lt;/strong&gt;ï¼Œæˆ‘ä»¬éƒ½æ˜¯ä»¥è¿™ç§æ–¹å¼æ¥æ’å…¥çš„ï¼Œæ‰€ä»¥æœ‰åºçš„æ¶ˆæ¯é˜Ÿåˆ—å°±æ˜¯ç®€å•ä»¥æ¶ˆæ¯çš„&lt;strong&gt;when&lt;/strong&gt;çš„å¤§å°æ¥æ’åºçš„ã€‚æ¶ˆæ¯æ’å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—å®Œæˆåï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦å”¤é†’ä¸»çº¿ç¨‹ï¼Œéœ€è¦åˆ™è°ƒç”¨nativeæ–¹æ³•&lt;strong&gt;nativeWake()&lt;/strong&gt;å”¤é†’ä¸»çº¿ç¨‹æ¥å¤„ç†æ¶ˆæ¯ï¼ˆ&lt;code class=&quot;highlighter-rouge&quot;&gt; Message msg = queue.next();//Looper.loop()æ–¹æ³•ä¸­è¢«å”¤é†’åå–å‡ºæ¶ˆæ¯å¹¶åˆ†å‘å¤„ç†&lt;/code&gt;ï¼‰ã€‚æœ€åè¿”å›&lt;strong&gt;true&lt;/strong&gt;è¡¨æ˜æ¶ˆæ¯æ’å…¥é˜Ÿåˆ—æˆåŠŸã€‚è¿™æ ·&lt;strong&gt;Message&lt;/strong&gt;å…¥é˜Ÿçš„è¿‡ç¨‹å°±ç®—å®Œæˆäº†ï¼Œæ˜¯ä¸æ˜¯æŒºç®€å•çš„~&lt;/p&gt;

&lt;p&gt;ä»¥ä¸Šï¼Œå°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯ä¼ é€’å’Œåˆ†å‘è¿‡ç¨‹ã€‚å®é™…ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬ç”¨åˆ°æ›´å¤šçš„å¯èƒ½æ˜¯&lt;code class=&quot;highlighter-rouge&quot;&gt;handler.post(runnable);&lt;/code&gt;,&lt;code class=&quot;highlighter-rouge&quot;&gt;handler.postDelayed(runnable,delayMillis);&lt;/code&gt;,&lt;code class=&quot;highlighter-rouge&quot;&gt;view.postDelayed(runnable,delayMillis);&lt;/code&gt;ä¹‹ç±»çš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•çœ‹ä¸Šå»å¥½åƒæ²¡æœ‰&lt;strong&gt;Message&lt;/strong&gt;ä»€ä¹ˆäº‹ï¼Œä½†æ˜¯ç‚¹è¿›å»ä¸€çœ‹å°±å‘ç°ï¼Œè¿™ä¸ªè¢«postçš„&lt;strong&gt;runnable&lt;/strong&gt;å°±æ˜¯&lt;strong&gt;Message&lt;/strong&gt;çš„&lt;strong&gt;callback&lt;/strong&gt;ï¼Œç®€å•å°è£…ä¸€ä¸‹å°±åˆèµ°ä¸Šäº†åˆšåˆšè®²å®Œçš„æ¶ˆæ¯ä¼ é€’è·¯çº¿ï¼Œè¿˜æ²¡ååº”è¿‡æ¥çš„å›å¤´çœ‹çœ‹&lt;strong&gt;handler&lt;/strong&gt;çš„&lt;strong&gt;dispatchMessage(Message msg)&lt;/strong&gt;æ–¹æ³•ï¼Œå› æ­¤è¿™äº›æ–¹å¼æˆ‘ä»¬éƒ½ä¸ç”¨é‡å†™&lt;strong&gt;handleMessage(Message msg)&lt;/strong&gt;æ–¹æ³•,ä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚&lt;strong&gt;&lt;em&gt;å‹æƒ…æç¤ºï¼šéå¸¸æ–¹ä¾¿çš„åŒæ—¶ä¹Ÿéå¸¸å®¹æ˜“å¯¼è‡´å†…å­˜æ³„éœ²ã€ç©ºæŒ‡é’ˆå’Œå…¶ä»–ä¸€äº›çŠ¶æ€ç´Šä¹±çš„é”™è¯¯ï¼ˆåˆ«é—®æˆ‘æ€ä¹ˆçŸ¥é“çš„ï¼Œæ­»è¿‡å¤ªå¤šè„‘ç»†èƒğŸ˜­ï¼‰ï¼Œæ…ç”¨ï¼ï¼ï¼&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;

</description>
        <pubDate>Mon, 06 Feb 2017 23:10:00 +0800</pubDate>
        <link>http://yourdomain.com/blog/2017/02/06/Android%E6%B6%88%E6%81%AF%E5%88%86%E5%8F%91%E5%8F%8A%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2%E4%B9%8BHandler-Message%E7%9A%84%E7%BB%86%E6%9E%9D%E6%9C%AB%E8%8A%82-%E4%BA%8C.html</link>
        <guid isPermaLink="true">http://yourdomain.com/blog/2017/02/06/Android%E6%B6%88%E6%81%AF%E5%88%86%E5%8F%91%E5%8F%8A%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2%E4%B9%8BHandler-Message%E7%9A%84%E7%BB%86%E6%9E%9D%E6%9C%AB%E8%8A%82-%E4%BA%8C.html</guid>
        
        
        <category>Blog</category>
        
      </item>
    
      <item>
        <title>Androidæ¶ˆæ¯åˆ†å‘åŠå¤šçº¿ç¨‹åˆ‡æ¢ä¹‹Handlerã€Messageçš„ç»†ææœ«èŠ‚ï¼ˆä¸€ï¼‰</title>
        <description>&lt;p&gt;ä»Šå¤©æ¥æ‰’ä¸€æ‰’Androidçš„æ¶ˆæ¯åˆ†å‘æœºåˆ¶å’Œå¤šçº¿ç¨‹åˆ‡æ¢è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸å¸¸çœ‹åˆ°ç”¨çš„Handlerï¼ŒMessageï¼ˆè¿˜æœ‰ä¸¤ä¸ªä¸å¤ªçœ‹å¾—åˆ°çš„MessageQueueå’ŒLooperï¼‰å®ƒä»¬çš„åŸç†ã€‚é¢ï¼Œå½“ç„¶æœ‰äººä¼šè¯´è¿˜æœ‰AsyncTaskè¿™ç©æ„å„¿ï¼Œæ€ä¹ˆè¯´å‘¢ï¼Œåæ­£æˆ‘æ˜¯åŸºæœ¬æ²¡ç”¨è¿‡AsyncTaskï¼Œä¹Ÿæ²¡è§è°å–œæ¬¢ç”¨è¿™ä¸ªï¼Œæ€»æ„Ÿè§‰ä½¿ç”¨èµ·æ¥æ²¡Handler+Messageæ–¹ä¾¿ï¼Œç„¶è€Œæˆ‘ç”¨çš„æ›´å¤šçš„æ˜¯Handler+Runnableï¼Œå½“ç„¶å®é™…ä¸ŠRunnableè¿˜æ˜¯è¢«åŒ…è£…æˆäº†Messageã€‚&lt;/p&gt;

&lt;p&gt;å…ˆç®€å•ä»‹ç»ä¸€ä¸‹è¿™å‡ ä¸ªç±»å§ï¼š&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;Handler:&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;

 	å¤„ç†è€…ï¼Œä¸€èˆ¬åœ¨ä¸»çº¿ç¨‹åˆ›å»ºï¼ˆåœ¨å·¥ä½œçº¿ç¨‹ä¹Ÿå¯ä»¥åˆ›å»ºï¼Œè¿™ä¸ªä¸‹ä¸€ç¯‡ä¼šè¯¦ç»†è¯´åˆ°ï¼‰ï¼Œå¤„ç†å„ç§çº¿ç¨‹å‘é€è¿‡æ¥çš„* Messageï¼Œæ ¹æ®Messageå†…å®¹åœ¨ä¸»çº¿ç¨‹åšä¸åŒçš„å¤„ç†ã€‚
&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Message:&lt;/strong&gt;&lt;/p&gt;

    &lt;p&gt;æ¶ˆæ¯ä½“ï¼Œåœ¨å¤šçº¿ç¨‹ä¸­æ‹…ä»»ä¸€ä¸ªå†…å®¹è½½ä½“çš„è§’è‰²ï¼ŒåŒ…å«äº†æ¶ˆæ¯çš„ç±»å‹ï¼Œå‚æ•°ï¼Œæ•°æ®ç­‰å†…å®¹ï¼Œå…¶ä¸­è¿˜åŒ…æ‹¬ä¸€ä¸ªé‡è¦çš„å¯¹è±¡ï¼Œé‚£å°±æ˜¯å®ƒå°†ä¼šè¢«å‘é€ç»™é‚£ä¸ªhandlerã€‚&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;MessageQueueï¼š&lt;/strong&gt;&lt;/p&gt;

    &lt;p&gt;æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ‰€æœ‰å‘é€ç»™handlerå¤„ç†çš„æ¶ˆæ¯éƒ½ä¼šä¿å­˜åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œå…¶å†…éƒ¨ä½¿ç”¨é“¾è¡¨çš„å½¢å¼ç»´æŠ¤è¿™äº›messageã€‚&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Looperï¼š&lt;/strong&gt;&lt;/p&gt;

    &lt;p&gt;è¿™ä¸ªæ€ä¹ˆè¯´å‘¢ï¼Œå®ƒçš„è‹±æ–‡è§£é‡Šä¸ºä¸€ä¸ªæ‰“ç¯çš„è£…ç½®ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“è¯¥æ€ä¹ˆç¿»è¯‘ï¼Œå®ƒçš„ä½œç”¨æ˜¯å¯ä»¥è®©çº¿ç¨‹ä¸€ç›´æ´»ç€ï¼Œè€Œä¸æ˜¯æ‰§è¡Œå®Œä¸€ä¸ªåŠŸèƒ½ä»£ç åå°±æ­»æ‰äº†ï¼Œæ¯ä¸ªLooperçš„å®ä¾‹æœ‰ä¸€ä¸ªMessageQueueå’Œå½“å‰çº¿ç¨‹å¯¹è±¡ï¼Œæ­£æ˜¯è¿™ä¸¤ä¸ªç±»è®©çº¿ç¨‹å¯ä»¥ä¸€ç›´æ´»ç€ï¼Œä¹Ÿå°±æ˜¯Looperæ‰“ç¯çš„è£…ç½®çš„æ„æ€å§ã€‚æˆ‘ä»¬çš„ä¸»çº¿ç¨‹å°±æ˜¯å› ä¸ºå®ƒæ‰å¯ä»¥ä¸€ç›´æ‰§è¡Œè€Œä¸é€€å‡ºã€‚&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ä¸Šé¢è¯´åˆ°Looperä½¿æˆ‘ä»¬çš„ä¸»çº¿ç¨‹å¯ä»¥ä¸€ç›´è¿è¡Œï¼Œç©¶ç«Ÿæ˜¯å’‹å›äº‹ï¼Œä¸Šä»£ç ï¼ï¼ï¼&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; public static void main(String[] args) {
        Â·Â·Â·Â·Â·Â·
        Looper.prepareMainLooper();

        ActivityThread thread = new ActivityThread();
        thread.attach(false);

        if (sMainThreadHandler == null) {
            sMainThreadHandler = thread.getHandler();
        }
		Â·Â·Â·Â·Â·Â·
        Looper.loop();

        throw new RuntimeException(&quot;Main thread loop unexpectedly exited&quot;);
    }
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;æ²¡é”™ï¼Œå°±æ˜¯æˆ‘ä»¬çš„ä¸»çº¿ç¨‹åˆå§‹åŒ–çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯åº”ç”¨ç¨‹åºå¯åŠ¨çš„å…¥å£ã€‚æˆ‘ä»¬çš„åº”ç”¨å¯¹äºAndroidç³»ç»Ÿè€Œè¨€ï¼Œè¯´ç™½äº†ä¹Ÿå°±æ˜¯ä¸€æ®µç¨‹åºä»£ç ï¼Œé‚£ä¹ˆç¨‹åºå¯åŠ¨çš„æ—¶å€™å½“ç„¶å¾—ä»å¯åŠ¨æ–¹æ³•å¼€å§‹äº†ï¼Œå®ƒå°±æ˜¯&lt;strong&gt;ActivityThread&lt;/strong&gt;ä¸­å¤§åé¼é¼çš„&lt;strong&gt;main()&lt;/strong&gt;æ–¹æ³•ï¼Œæ˜¯ä¸æ˜¯æƒ³èµ·æ¥javaä¸­çš„&lt;strong&gt;main()&lt;/strong&gt;æ–¹æ³•ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™é‡Œåˆ°åº•åšäº†å“ªäº›äº‹ã€‚é¦–å…ˆå°±æ˜¯è°ƒç”¨äº†&lt;strong&gt;Looper&lt;/strong&gt;çš„é™æ€æ–¹æ³•&lt;strong&gt;preoareMainLooper()&lt;/strong&gt;:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;	/**
     * Initialize the current thread as a looper, marking it as an
     * application&#39;s main looper. The main looper for your application
     * is created by the Android environment, so you should never need
     * to call this function yourself.  See also: {@link #prepare()}
     */
    public static void prepareMainLooper() {
        prepare(false);
        synchronized (Looper.class) {
            if (sMainLooper != null) {
                throw new IllegalStateException(&quot;The main Looper has already been prepared.&quot;);
            }
            sMainLooper = myLooper();
        }
    }
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;è¿™ä¸ªæ˜¯æºç åŸå°ä¸åŠ¨çš„è´´ä¸Šæ¥çš„ï¼ŒåŒ…æ‹¬æ³¨é‡Šï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•åº”è¯¥ç”±ç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒæ ¹æ®å½“å‰çº¿ç¨‹åˆå§‹åŒ–ä¸€ä¸ª&lt;strong&gt;Looper&lt;/strong&gt;å¯¹è±¡ï¼Œå¹¶ä¸”æ˜¯åº”ç”¨çš„â€main looperâ€ï¼Œä¹Ÿå°±æ˜¯æ–¹æ³•åæ‰€è¡¨ç°çš„ï¼Œæ¥ç€çœ‹æ–¹æ³•é‡Œçš„ç¬¬ä¸€è¡Œè°ƒç”¨ã€‚&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;	private static void prepare(boolean quitAllowed) {
        if (sThreadLocal.get() != null) {
            throw new RuntimeException(&quot;Only one Looper may be created per thread&quot;);
        }
        sThreadLocal.set(new Looper(quitAllowed));
    }
    
    private Looper(boolean quitAllowed) {
        mQueue = new MessageQueue(quitAllowed);
        mThread = Thread.currentThread();
    }
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;è¿™é‡Œæœ‰ä¸ª&lt;strong&gt;sThreadLocal&lt;/strong&gt;ï¼Œå®ƒæ˜¯ä¸€ä¸ªé™æ€å±æ€§ï¼š**static final ThreadLocal&lt;Looper&gt; sThreadLocal = new ThreadLocal&lt;Looper&gt;();**ï¼Œä¹Ÿå°±æ˜¯å…¨å±€å°±ä¸€ä¸ªï¼Œæ¯ä¸ªçº¿ç¨‹æœ€å¤šå¯¹åº”ä¸€ä¸ª**Looper**å¯¹è±¡ï¼Œå¦‚æœæœ‰ï¼Œ**Looper**å¯¹è±¡éƒ½ä¼šä¿å­˜åœ¨**sThreadLocal**ä¸­ï¼Œæˆ‘ä»¬ç®€å•çš„æŠŠå®ƒç†è§£ä¸ºä¸€ä¸ªMapå°±è¡Œï¼Œkeyä¸ºå½“å‰çš„çº¿ç¨‹ï¼Œvalueä¸ºä¸€ä¸ª**Looper**å®ä¾‹ï¼Œå› ä¸ºçº¿ç¨‹ï¼ˆä¹Ÿå°±æ˜¯keyï¼‰åœ¨æ–¹æ³•è°ƒç”¨çš„æ—¶å€™å†…éƒ¨å¯ä»¥å–åˆ°ï¼Œæ‰€ä»¥å¯¹å®ƒè¿›è¡Œgetï¼Œsetæ“ä½œçš„æ—¶å€™ä¸éœ€è¦ä¼ keyï¼Œç›´æ¥ä¼ valueå°±è¡Œï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•å°±å¾ˆå¥½ç†è§£äº†ï¼Œå¦‚æœä¹‹å‰è°ƒç”¨è¿‡è¿™ä¸ªæ–¹æ³•ï¼Œ**sThreadLocal.get()**åˆ™ä¸ä¸ºnull,ç›´æ¥æŠ›å¼‚å¸¸ï¼ˆä¹Ÿå°±è¯´æ˜äº†ä¸€ä¸ªçº¿ç¨‹æœ€å¤šåªèƒ½å¯¹åº”ä¸€ä¸ª**Looper**å¯¹è±¡ï¼‰ï¼Œå¦åˆ™newä¸€ä¸ª**Looper**å¯¹è±¡å­˜åˆ°**sThreadLocal**ä¸­ï¼Œ**Looper**å¯¹è±¡åˆå§‹åŒ–çš„åŒæ—¶ä¹Ÿåˆå§‹åŒ–äº†ä¸€ä¸ª**MessageQueue**ï¼Œå¹¶ä¸”æŒæœ‰äº†å½“å‰çº¿ç¨‹çš„å¼•ç”¨ã€‚&lt;/Looper&gt;&lt;/Looper&gt;&lt;/p&gt;

&lt;p&gt;å¥½ï¼Œç»§ç»­çœ‹&lt;strong&gt;prepareMainLooper&lt;/strong&gt;æ–¹æ³•ï¼Œåˆ¤æ–­&lt;strong&gt;sMainLooper&lt;/strong&gt;æ˜¯å¦ä¸ºnullï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨å½“ç„¶ä¸ºnullï¼Œæ‰€ä»¥&lt;strong&gt;sMainLooper = myLooper();&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;	/**
     * Return the Looper object associated with the current thread.  Returns
     * null if the calling thread is not associated with a Looper.
     */
    public static @Nullable Looper myLooper() {
        return sThreadLocal.get();
    }
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;å¾ˆç®€å•ï¼Œç›´æ¥è°ƒç”¨&lt;strong&gt;sThreadLocal.get()&lt;/strong&gt;æ–¹æ³•ï¼Œå¾ˆçœ¼ç†Ÿæ˜¯å§ï¼Œæˆ‘ä»¬åˆšåˆšè°ƒç”¨è¿‡å®ƒçš„&lt;strong&gt;set()&lt;/strong&gt;æ–¹æ³•ï¼Œè¿™ä¸ªæ—¶å€™è¿˜åœ¨åˆšæ‰çš„çº¿ç¨‹ä¸­å‘¢ï¼Œæ‰€ä»¥è¿™é‡Œå–å‡ºæ¥çš„å°±æ˜¯æˆ‘ä»¬åˆšåˆšæ”¾è¿›å»çš„&lt;strong&gt;new Looper()&lt;/strong&gt;ï¼Œå¯ä»¥ç¨å¾®çœ‹ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ä¸­æœ‰ä¸ªå‚æ•°å°±&lt;strong&gt;quitAllowed&lt;/strong&gt;ï¼Œæœ€ç»ˆè¢«ä¼ åˆ°äº†&lt;strong&gt;MessageQueue&lt;/strong&gt;çš„æ„é€ å™¨ä¸­ï¼Œåº”è¯¥å¯ä»¥çŒœåˆ°å®ƒè¡¨ç¤ºè¿™ä¸ª&lt;strong&gt;MessageQueue&lt;/strong&gt;æ˜¯å¦å¯ä»¥è¢«é€€å‡ºæˆ–è€…è¯´è¿™ä¸ªçº¿ç¨‹æ˜¯å¦èƒ½è¢«ç»“æŸæ‰ï¼Œå½“ç„¶å› ä¸ºæˆ‘ä»¬çš„çº¿ç¨‹æ˜¯ä¸»çº¿ç¨‹ï¼Œæ‰€ä»¥ä¼ &lt;strong&gt;false&lt;/strong&gt;ã€‚ç›®å‰ä¸ºæ­¢æˆ‘ä»¬å·²ç»å®Œæˆäº†&lt;strong&gt;prepareMainLooper()&lt;/strong&gt;æ–¹æ³•ï¼Œå®ƒæ‰€åšçš„äº‹å…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯å°†æˆ‘ä»¬çš„çº¿ç¨‹ä½œä¸ºkeyåœ¨&lt;strong&gt;sThreadLocal&lt;/strong&gt;ä¸­ä¿å­˜äº†ä¸€ä¸ªä¸å¯é€€å‡ºçš„&lt;strong&gt;Looper&lt;/strong&gt;å¯¹è±¡ï¼ŒåŒæ—¶èµ‹å€¼ç»™&lt;strong&gt;sMainLooper&lt;/strong&gt;ï¼Œä¸ºä»€ä¹ˆè¿˜è¦å•ç‹¬å®šä¹‰ä¸€ä¸ª&lt;strong&gt;sMainLooper&lt;/strong&gt;å‘¢ï¼Ÿé¦–å…ˆ&lt;strong&gt;sMainLooper&lt;/strong&gt;æ˜¯ä¸€ä¸ªé™æ€å±æ€§ï¼Œä¸”æœ‰ä¸€ä¸ª&lt;strong&gt;getMainLooper()&lt;/strong&gt;é™æ€æ–¹æ³•ç›´æ¥è¿”å›&lt;strong&gt;sMainLooper&lt;/strong&gt;,æ‰€ä»¥æˆ‘çŒœæµ‹æ˜¯å› ä¸ºä¸»çº¿ç¨‹çš„&lt;strong&gt;Looper&lt;/strong&gt;å¯¹è±¡è·å–æ¯”è¾ƒé¢‘ç¹ï¼Œæ‰€ä»¥å•ç‹¬ä½œä¸ºä¸€ä¸ªå±æ€§ç›´æ¥è¯»å–ï¼Œçœçš„æ¯æ¬¡ä»&lt;strong&gt;sThreadLocal&lt;/strong&gt;ä¸­å»å–ï¼Œä»¥æ­¤å‡å°å¼€é”€ã€‚&lt;/p&gt;

&lt;p&gt;ä¸‹é¢æ”¾ä¸€å¼ å›¾ä½œä¸ºprepareMainLooperçš„æ€»ç»“å§ï¼Œå¯¹ç€å›¾çœ‹åº”è¯¥æ¸…æ™°å¾ˆå¤šï¼š
&lt;img src=&quot;prepareMainLooper.001.jpeg&quot; alt=&quot;image&quot; /&gt;&lt;/p&gt;

&lt;p&gt;å›å¤´ç»§ç»­çœ‹&lt;strong&gt;main()&lt;/strong&gt;æ–¹æ³•ï¼Œæ¥ä¸‹å»newäº†ä¸€ä¸ªActivityThreadå®ä¾‹&lt;strong&gt;thread&lt;/strong&gt;ï¼Œå¹¶ä¸”è°ƒç”¨äº†&lt;strong&gt;attach()&lt;/strong&gt;æ–¹æ³•ï¼Œç„¶åå°†&lt;strong&gt;thread.getHandler()&lt;/strong&gt;è¿”å›ç»™&lt;strong&gt;sMainThreadHandler&lt;/strong&gt;ï¼Œè¿™å‡ è¡Œä»£ç ä¸»è¦æ˜¯åˆå§‹åŒ–äº†æˆ‘ä»¬çš„åº”ç”¨è¿›ç¨‹å’ŒAndroidç³»ç»Ÿçš„é€šä¿¡åŸºç¡€ï¼Œä¹Ÿå°±æ˜¯Binderç»„ä»¶ï¼Œä½¿å¾—æˆ‘ä»¬çš„åº”ç”¨è¿›ç¨‹å’ŒAndroidç³»ç»Ÿèƒ½å¤Ÿé€šä¿¡ï¼Œè¿™é‡Œæˆ‘ä»¬åªè¦çŸ¥é“ä¸ªå¤§æ¦‚ï¼Œå°±æ˜¯Androidç³»ç»Ÿä¼šå‘é€æ¶ˆæ¯ç»™æˆ‘ä»¬çš„åº”ç”¨çš„&lt;strong&gt;ActivityThread&lt;/strong&gt;(å¥½å§ï¼Œå…¶å®æ˜¯å®ƒçš„ä¸€ä¸ªå†…éƒ¨ç±»&lt;strong&gt;ApplicationThread&lt;/strong&gt;)ï¼Œç„¶åç”±&lt;strong&gt;ActivityThread&lt;/strong&gt;åŒ…è£…æˆ&lt;strong&gt;Message&lt;/strong&gt;æ”¾å…¥&lt;strong&gt;sMainLooper&lt;/strong&gt;çš„&lt;strong&gt;MessageQueue&lt;/strong&gt;ä¸­ç­‰å¾…æ‰§è¡Œã€‚å¦‚ä½•æ‰§è¡Œï¼Œè¯·å¾€ä¸‹çœ‹â€¦â€¦&lt;/p&gt;

&lt;p&gt;å†æ¥ä¸‹å»æ˜¯&lt;strong&gt;Looper.loop()&lt;/strong&gt;æ–¹æ³•&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;	/**
     * Run the message queue in this thread. Be sure to call
     * {@link #quit()} to end the loop.
     */
    public static void loop() {
        final Looper me = myLooper();
        if (me == null) {
            throw new RuntimeException(&quot;No Looper; Looper.prepare() wasn&#39;t called on this thread.&quot;);
        }
        final MessageQueue queue = me.mQueue;
		Â·Â·Â·Â·Â·Â·
        for (;;) {
            Message msg = queue.next(); // might block
            if (msg == null) {
                // No message indicates that the message queue is quitting.
                return;
            }

          	Â·Â·Â·Â·Â·Â·

            msg.target.dispatchMessage(msg);

            Â·Â·Â·Â·Â·Â·

            msg.recycleUnchecked();
        }
    }
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;å¯ä»¥çœ‹åˆ°ä»¥ä¸Šä»£ç é€»è¾‘ä¹Ÿååˆ†ç®€å•ï¼Œè·å–å½“å‰çº¿ç¨‹çš„&lt;strong&gt;Looper&lt;/strong&gt;å¯¹è±¡ï¼Œè¿›è€Œè·å–&lt;strong&gt;Looper&lt;/strong&gt;å¯¹è±¡ä¸­çš„&lt;strong&gt;MessageQueue&lt;/strong&gt;ä¿å­˜ä¸º&lt;strong&gt;queue&lt;/strong&gt;ï¼Œç„¶åè¿›å…¥æ­»å¾ªç¯ï¼Œæ¯æ¬¡éƒ½ä»&lt;strong&gt;queue&lt;/strong&gt;ä¸­å–ä¸‹ä¸€ä¸ª&lt;strong&gt;Message&lt;/strong&gt;ï¼Œå¾—åˆ°&lt;strong&gt;Message&lt;/strong&gt;åç›´æ¥è°ƒç”¨&lt;strong&gt;Message&lt;/strong&gt;å¯¹è±¡ä¸­ä¿å­˜çš„ç›®æ ‡&lt;strong&gt;handler&lt;/strong&gt;çš„&lt;strong&gt;dispatchMessageï¼ˆï¼‰&lt;/strong&gt;æ–¹æ³•ï¼Œç„¶åå›æ”¶&lt;strong&gt;Message&lt;/strong&gt;è¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ã€‚è‡³æ­¤ï¼Œæˆ‘ä»¬çš„ä¸»çº¿ç¨‹æ‰æˆä¸ºäº†çœŸæ­£æ„ä¹‰ä¸Šçš„ä¸»çº¿ç¨‹ã€‚ä¸Šé¢è¯´åˆ°Androidç³»ç»Ÿä¼šç»™æˆ‘ä»¬åº”ç”¨å‘æ¶ˆæ¯ï¼Œç„¶åæ¶ˆæ¯è¢«åŒ…è£…æˆ&lt;strong&gt;Message&lt;/strong&gt;ä¿å­˜åœ¨&lt;strong&gt;MessageQueue&lt;/strong&gt;ä¸­ï¼Œè€Œåœ¨&lt;strong&gt;loop()&lt;/strong&gt;æ–¹æ³•ä¸­æˆ‘ä»¬åˆå»å–ä¸‹ä¸€ä¸ª&lt;strong&gt;Message&lt;/strong&gt;ï¼Œæ˜¯ä¸æ˜¯å‘ç°äº†ä»€ä¹ˆï¼Ÿä¸é”™ï¼Œæˆ‘ä»¬åº”ç”¨ä¸­çš„å„ç§ç³»ç»Ÿæ–¹æ³•çš„è°ƒç”¨å…¶å®éƒ½æ˜¯éƒ½å°†Androidç³»ç»Ÿå‘é€çš„æ¶ˆæ¯åŒ…è£…æˆ&lt;strong&gt;Message&lt;/strong&gt;ä¿å­˜åˆ°æˆ‘ä»¬çš„åº”ç”¨ä¸»çº¿ç¨‹ç»‘å®šçš„&lt;strong&gt;sMainLooper&lt;/strong&gt;ä¸­çš„&lt;strong&gt;MessageQueue&lt;/strong&gt;ä¸­ï¼Œç„¶åç”±è¿™ä¸ªæ­»å¾ªç¯ä»&lt;strong&gt;MessageQueue&lt;/strong&gt;ä¸­å–ä¾æ¬¡å‡º&lt;strong&gt;Message&lt;/strong&gt;æ¶ˆæ¯è¿›è€Œæ‰§è¡Œå¯¹åº”çš„æ–¹æ³•ï¼Œè¿™æ ·ä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯ä¼ é€’è¿‡ç¨‹å°±æ‰“é€šäº†ï¼&lt;/p&gt;

&lt;p&gt;è€æ ·å­ï¼Œçœ‹å›¾ï¼š
&lt;img src=&quot;loop.001.jpeg&quot; alt=&quot;image&quot; /&gt;&lt;/p&gt;

&lt;p&gt;æˆ‘ä¸ªäººè®¤ä¸ºä»¥ä¸Šå†…å®¹å·²ç»æ˜¯&lt;strong&gt;Handler&lt;/strong&gt;å’Œ&lt;strong&gt;Message&lt;/strong&gt;å®Œæˆå¤šçº¿ç¨‹åˆ‡æ¢å’Œæ¶ˆæ¯ä¼ é€’çš„æ ¸å¿ƒå†…å®¹äº†ï¼Œä¸»è¦ä¹Ÿå°±æ˜¯&lt;strong&gt;Looper&lt;/strong&gt;ç±»çš„ç”¨å¤„å’Œç”¨æ³•ï¼Œçœ‹æ‡‚äº†è¿™äº›å†…å®¹å†çœ‹æ•´ä¸ªæµç¨‹ä¼šå¾ˆè½»æ¾ï¼Œæ‰€ä»¥å¦‚æœè¿˜æ²¡ç†è§£çš„è¯å»ºè®®å†çœ‹å‡ éï¼Œæˆ–è€…ç›´æ¥å»çœ‹çœ‹Looperçš„æºç æ›´å¥½ã€‚&lt;/p&gt;

&lt;p&gt;å…¶å®è¿˜ä¸€ä¸ªæ¯”è¾ƒå…³é”®çš„æ­¥éª¤ï¼šå¦‚ä½•ä»&lt;strong&gt;MessageQueue&lt;/strong&gt;å–&lt;strong&gt;Message&lt;/strong&gt;ï¼Œä¸è¿‡ä¸ªäººæ„Ÿè§‰å°±ç®—è¿™ä¸ªè¿‡ç¨‹å¯¹äºç†è§£æ•´ä¸ªæ¶ˆæ¯ä¼ é€’æœºåˆ¶å½±å“ä¸å¤§ï¼Œåªè¦çŸ¥é“&lt;strong&gt;MessageQueue&lt;/strong&gt;ä»¥é“¾è¡¨çš„å½¢å¼ç»´æŠ¤è¿™æ¯ä¸ªè¿›å…¥é˜Ÿåˆ—çš„&lt;strong&gt;Message&lt;/strong&gt;å°±è¡Œäº†ã€‚æœ‰å…´è¶£çš„å°ä¼™ä¼´ä¹Ÿå¯ä»¥çœ‹çœ‹æºç ï¼Œæˆ‘å°±åœ¨è¿™é‡Œè´´ä¸€ä¸‹&lt;strong&gt;MessageQueue.next()&lt;/strong&gt;æ–¹æ³•çš„æºç å§ï¼š&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;	Message next() {
        // Return here if the message loop has already quit and been disposed.
        // This can happen if the application tries to restart a looper after quit
        // which is not supported.
        final long ptr = mPtr;
        if (ptr == 0) {
            return null;
        }

        int pendingIdleHandlerCount = -1; // -1 only during first iteration
        int nextPollTimeoutMillis = 0;
        for (;;) {
            if (nextPollTimeoutMillis != 0) {
                Binder.flushPendingCommands();
            }

            nativePollOnce(ptr, nextPollTimeoutMillis);

            synchronized (this) {
                // Try to retrieve the next message.  Return if found.
                final long now = SystemClock.uptimeMillis();
                Message prevMsg = null;
                Message msg = mMessages;
                if (msg != null &amp;amp;&amp;amp; msg.target == null) {
                    // Stalled by a barrier.  Find the next asynchronous message in the queue.
                    do {
                        prevMsg = msg;
                        msg = msg.next;
                    } while (msg != null &amp;amp;&amp;amp; !msg.isAsynchronous());
                }
                if (msg != null) {
                    if (now &amp;lt; msg.when) {
                        // Next message is not ready.  Set a timeout to wake up when it is ready.
                        nextPollTimeoutMillis = (int) Math.min(msg.when - now, Integer.MAX_VALUE);
                    } else {
                        // Got a message.
                        mBlocked = false;
                        if (prevMsg != null) {
                            prevMsg.next = msg.next;
                        } else {
                            mMessages = msg.next;
                        }
                        msg.next = null;
                        if (DEBUG) Log.v(TAG, &quot;Returning message: &quot; + msg);
                        msg.markInUse();
                        return msg;
                    }
                } else {
                    // No more messages.
                    nextPollTimeoutMillis = -1;
                }

                // Process the quit message now that all pending messages have been handled.
                if (mQuitting) {
                    dispose();
                    return null;
                }

                // If first time idle, then get the number of idlers to run.
                // Idle handles only run if the queue is empty or if the first message
                // in the queue (possibly a barrier) is due to be handled in the future.
                if (pendingIdleHandlerCount &amp;lt; 0
                        &amp;amp;&amp;amp; (mMessages == null || now &amp;lt; mMessages.when)) {
                    pendingIdleHandlerCount = mIdleHandlers.size();
                }
                if (pendingIdleHandlerCount &amp;lt;= 0) {
                    // No idle handlers to run.  Loop and wait some more.
                    mBlocked = true;
                    continue;
                }

                if (mPendingIdleHandlers == null) {
                    mPendingIdleHandlers = new IdleHandler[Math.max(pendingIdleHandlerCount, 4)];
                }
                mPendingIdleHandlers = mIdleHandlers.toArray(mPendingIdleHandlers);
            }

            // Run the idle handlers.
            // We only ever reach this code block during the first iteration.
            for (int i = 0; i &amp;lt; pendingIdleHandlerCount; i++) {
                final IdleHandler idler = mPendingIdleHandlers[i];
                mPendingIdleHandlers[i] = null; // release the reference to the handler

                boolean keep = false;
                try {
                    keep = idler.queueIdle();
                } catch (Throwable t) {
                    Log.wtf(TAG, &quot;IdleHandler threw exception&quot;, t);
                }

                if (!keep) {
                    synchronized (this) {
                        mIdleHandlers.remove(idler);
                    }
                }
            }

            // Reset the idle handler count to 0 so we do not run them again.
            pendingIdleHandlerCount = 0;

            // While calling an idle handler, a new message could have been delivered
            // so go back and look again for a pending message without waiting.
            nextPollTimeoutMillis = 0;
        }
    }

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;æœ¬æ¥åªæƒ³å†™ä¸€ç¯‡çš„ï¼Œä¸è¿‡æ„Ÿè§‰å¥½åƒæœ‰ç‚¹é•¿äº†ï¼Œè¿™æ ·çš„è¯å°±å†å†™ä¸€ç¯‡å§ï¼Œè¿™ç¯‡å°±å½“åšæ˜¯ç†è®ºçŸ¥è¯†çš„ä¸€ä¸ªè¡¥å……ï¼Œæ¥ä¸‹å»è®²è®²é¡ºç€å®é™…åº”ç”¨è¿‡ç¨‹çš„çº¿ç´¢ï¼Œä¸€æ­¥æ­¥æ˜¯å¦‚ä½•å°†æ¶ˆæ¯æ”¾å…¥&lt;strong&gt;MessageQueue&lt;/strong&gt;åˆ°æœ€åæ‰§è¡Œçš„~&lt;/p&gt;
</description>
        <pubDate>Wed, 25 Jan 2017 23:10:00 +0800</pubDate>
        <link>http://yourdomain.com/blog/2017/01/25/Android%E6%B6%88%E6%81%AF%E5%88%86%E5%8F%91%E5%8F%8A%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2%E4%B9%8BHandler-Message%E7%9A%84%E7%BB%86%E6%9E%9D%E6%9C%AB%E8%8A%82-%E4%B8%80.html</link>
        <guid isPermaLink="true">http://yourdomain.com/blog/2017/01/25/Android%E6%B6%88%E6%81%AF%E5%88%86%E5%8F%91%E5%8F%8A%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2%E4%B9%8BHandler-Message%E7%9A%84%E7%BB%86%E6%9E%9D%E6%9C%AB%E8%8A%82-%E4%B8%80.html</guid>
        
        
        <category>Blog</category>
        
      </item>
    
      <item>
        <title>ç¬¬ä¸€ç¯‡åšå®¢</title>
        <description>&lt;h1 id=&quot;section&quot;&gt;ç¬¬ä¸€ç¯‡åšå®¢&lt;/h1&gt;

&lt;h2 id=&quot;markdown&quot;&gt;ç¯å¢ƒæ­å»ºæµ‹è¯•ï¼Œä½¿ç”¨markdownå†™æµ‹è¯•åšå®¢&lt;/h2&gt;
</description>
        <pubDate>Mon, 06 Jun 2016 23:10:00 +0800</pubDate>
        <link>http://yourdomain.com/blog/2016/06/06/FirstBlog.html</link>
        <guid isPermaLink="true">http://yourdomain.com/blog/2016/06/06/FirstBlog.html</guid>
        
        
        <category>Blog</category>
        
      </item>
    
  </channel>
</rss>
